<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Placeholder System</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2; 
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --info: #3498db;
            --light: #ecf0f1;
            --dark: #2c3e50;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
            position: relative;
        }

        .header h1 {
            color: var(--dark);
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            color: #666;
            font-size: 1.2em;
        }

        .back-btn {
            position: absolute;
            left: 30px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 15px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .back-btn:hover {
            transform: translateY(-50%) translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 30px;
        }

        .card-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 25px 30px;
            font-size: 1.3em;
            font-weight: 600;
        }

        .card-body {
            padding: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #2ecc71);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #f1c40f);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #c0392b);
        }

        .placeholder-item {
            background: #f8f9fa;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 10px;
            border-left: 4px solid var(--primary);
            position: relative;
        }

        .placeholder-item.active {
            border-left-color: var(--success);
            background: #f8fff8;
        }

        .placeholder-item.inactive {
            border-left-color: var(--warning);
            background: #fffbf0;
        }

        .placeholder-item.error {
            border-left-color: var(--danger);
            background: #fff8f8;
        }

        .placeholder-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .placeholder-key {
            font-family: 'Courier New', monospace;
            font-weight: 700;
            color: var(--primary);
            font-size: 1.1em;
            margin: 0;
        }

        .placeholder-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            color: white;
        }

        .status-badge.active { background: var(--success); }
        .status-badge.inactive { background: var(--warning); }
        .status-badge.error { background: var(--danger); }

        .test-button {
            padding: 4px 8px;
            font-size: 0.8em;
            border-radius: 6px;
        }

        .placeholder-value {
            margin-bottom: 10px;
            color: var(--dark);
        }

        .placeholder-test-value {
            background: #e9ecef;
            padding: 8px 12px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            margin-bottom: 10px;
            border: 1px solid #dee2e6;
        }

        .placeholder-pages {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
        }

        .page-tag {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            margin-right: 5px;
            margin-bottom: 3px;
        }

        .placeholder-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .placeholder-actions .btn {
            padding: 6px 12px;
            font-size: 0.9em;
            margin: 0;
        }

        .user-preview {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
        }

        .user-preview-header {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--primary);
        }

        .user-preview-value {
            font-family: 'Courier New', monospace;
            background: white;
            padding: 5px 8px;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .alert-info {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .hidden {
            display: none !important;
        }

        .template-code {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    
        html {
            overflow-x: hidden !important;
            touch-action: pan-y;
            width: 100%;
        }

        body {
            overflow-x: hidden !important;
            width: 100%;
            max-width: 100%;
        }

        .container {
            overflow-x: hidden !important;
            width: 100%;
            max-width: 1400px;
        }

    </style>
</head>
<body>
    <!-- Auth Check -->
    <script type="module">
        import { auth } from "../shared/js/firebase-init.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                alert("🔒 Cần đăng nhập admin để truy cập trang này");
                location.href = "/admin/admin-login.html";
            }
        });
    </script>

    <div class="container">
        <div class="header">
            <a href="../../index.html" class="back-btn">
                <i class="fas fa-arrow-left"></i> Quay lại
            </a>
            <h1><i class="fas fa-tags"></i> Placeholder System</h1>
            <p>Quản lý placeholder động cho hệ thống eTAX</p>
        </div>

        <!-- Page Selection & User Testing -->
        <div class="card">
            <div class="card-header">
                <i class="fas fa-cog"></i> Cấu hình Test & Preview
            </div>
            <div class="card-body">
                <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                    <div class="form-group" style="flex: 1;">
                        <label for="targetPage">Chọn trang để quản lý:</label>
                        <select id="targetPage" class="form-control" onchange="loadPagePlaceholders()">
                            <option value="all">🌐 Tất cả trang</option>
                            <optgroup label="⭐ HIGH PRIORITY">
                                <option value="index.html">🏠 index.html - Dashboard</option>
                                <option value="thongtin.html">👤 thongtin.html - User Profile</option>
                                <option value="dangky.html">📝 dangky.html - Registration</option>
                                <option value="nopthue.html">💰 nopthue.html - Tax Payment</option>
                                <option value="hoadondt.html">📄 hoadondt.html - E-Invoice</option>
                                <option value="khaithue.html">📋 khaithue.html - Tax Declaration</option>
                            </optgroup>
                            <optgroup label="🔶 MEDIUM PRIORITY">
                                <option value="thongtin-chitiet.html">👤 thongtin-chitiet.html - Detailed Profile</option>
                                <option value="thaydoittdkthue.html">🔄 thaydoittdkthue.html - Registration Change</option>
                                <option value="hoso.html">📁 hoso.html - Document Management</option>
                                <option value="tra-cuu-chung-tu.html">🔍 tra-cuu-chung-tu.html - Document Lookup</option>
                                <option value="nghiavu.html">⚖️ nghiavu.html - Tax Obligations</option>
                                <option value="ho-tro-qtt.html">🤝 ho-tro-qtt.html - Settlement Support</option>
                                <option value="ho-tro-qtthue.html">🤝 ho-tro-qtthue.html - Tax Finalization</option>
                                <option value="thongbao.html">📢 thongbao.html - Notifications</option>
                                <option value="thietlap.html">⚙️ thietlap.html - Settings</option>
                            </optgroup>
                            <optgroup label="🔸 LOW PRIORITY">
                                <option value="page-thongbao.html">📌 page-thongbao.html - Bulletin</option>
                                <option value="chi-tiet-thong-bao.html">📝 chi-tiet-thong-bao.html - Notification Detail</option>
                                <option value="doimatkhau.html">🔐 doimatkhau.html - Change Password</option>
                                <option value="van-tay.html">👆 van-tay.html - Biometric</option>
                                <option value="hotro.html">❓ hotro.html - Support</option>
                                <option value="tienich.html">🛠️ tienich.html - Utilities</option>
                                <option value="thongtinnvt.html">📊 thongtinnvt.html - NVT Info</option>
                                <option value="hsdkythue.html">🏠 hsdkythue.html - Land Tax</option>
                                <option value="tracuttnpt.html">👨‍👩‍👧‍👦 tracuttnpt.html - Dependent Lookup</option>
                                <option value="login.html">🔑 login.html - Login</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="testUser">Chọn user để test:</label>
                        <select id="testUser" class="form-control" onchange="previewPlaceholders()">
                            <option value="">Chọn user...</option>
                        </select>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-success" onclick="testPagePlaceholders()">
                        <i class="fas fa-play"></i> Test trang này
                    </button>
                    <button class="btn" onclick="refreshUsers()">
                        <i class="fas fa-sync"></i> Refresh Users
                    </button>
                    <button class="btn btn-warning" onclick="showPageTemplate()">
                        <i class="fas fa-code"></i> Show Template
                    </button>
                    <button class="btn" style="background: #6c757d; color: white;" onclick="debugSystem()">
                        <i class="fas fa-bug"></i> Debug
                    </button>
                    <button class="btn" style="background: #17a2b8; color: white;" onclick="testPreview()">
                        <i class="fas fa-eye"></i> Test Preview
                    </button>
                </div>
            </div>
        </div>

        <!-- Add New Placeholder -->
        <div class="card">
            <div class="card-header">
                <i class="fas fa-plus"></i> Thêm Placeholder Mới
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label for="placeholderKey">Placeholder Key</label>
                    <input type="text" id="placeholderKey" class="form-control" placeholder="{{user_name}}" />
                </div>
                <div class="form-group">
                    <label for="placeholderValue">Giá trị mặc định</label>
                    <textarea id="placeholderValue" class="form-control" rows="3" placeholder="Nhập giá trị mặc định..."></textarea>
                </div>
                <div class="form-group">
                    <label for="placeholderDescription">Mô tả</label>
                    <input type="text" id="placeholderDescription" class="form-control" placeholder="Mô tả placeholder này..." />
                </div>
                <div class="form-group">
                    <label for="targetPages">Áp dụng cho trang:</label>
                    <select id="targetPages" class="form-control" multiple>
                        <!-- Will be populated by JavaScript -->
                    </select>
                    <small class="text-muted">Ctrl+Click để chọn nhiều trang</small>
                </div>
                <button class="btn" onclick="addPlaceholder()">
                    <i class="fas fa-plus"></i> Thêm Placeholder
                </button>
                <button class="btn btn-warning" onclick="loadSampleData()">
                    <i class="fas fa-download"></i> Load Sample Data
                </button>
            </div>
        </div>

        <!-- Placeholder List -->
        <div class="card">
            <div class="card-header">
                <i class="fas fa-list"></i> Danh sách Placeholder - <span id="currentPageDisplay">Tất cả trang</span>
                <div style="float: right;">
                    <button class="btn" style="padding: 4px 8px; font-size: 12px;" onclick="toggleActiveView()">
                        <i class="fas fa-eye"></i> <span id="viewToggle">Hiện Active</span>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Filter Controls -->
                <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <div>
                            <label style="font-weight: 600; margin-bottom: 5px; display: block;">Lọc theo trạng thái:</label>
                            <select id="statusFilter" class="form-control" style="width: 150px;" onchange="filterPlaceholders()">
                                <option value="all">Tất cả</option>
                                <option value="active">✅ Active</option>
                                <option value="inactive">❌ Inactive</option>
                                <option value="error">⚠️ Error</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-weight: 600; margin-bottom: 5px; display: block;">Tìm kiếm:</label>
                            <input type="text" id="searchFilter" class="form-control" style="width: 200px;" placeholder="Tìm placeholder..." oninput="filterPlaceholders()" />
                        </div>
                        <div>
                            <label style="font-weight: 600; margin-bottom: 5px; display: block;">&nbsp;</label>
                            <button class="btn btn-success" onclick="testAllPlaceholders()">
                                <i class="fas fa-play-circle"></i> Test All
                            </button>
                        </div>
                    </div>
                </div>

                <div id="placeholderList">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> 
                        Chưa có placeholder nào. Hãy thêm placeholder đầu tiên!
                    </div>
                </div>
            </div>
        </div>

        <!-- Bulk Operations -->
        <div class="card">
            <div class="card-header">
                <i class="fas fa-cogs"></i> Thao tác hàng loạt
            </div>
            <div class="card-body">
                <button class="btn btn-success" onclick="exportPlaceholders()">
                    <i class="fas fa-download"></i> Xuất JSON
                </button>
                <button class="btn" onclick="importPlaceholders()">
                    <i class="fas fa-upload"></i> Import JSON
                </button>
                <button class="btn btn-danger" onclick="clearAllPlaceholders()">
                    <i class="fas fa-trash"></i> Xóa tất cả
                </button>
                <input type="file" id="importFile" style="display: none;" accept=".json" onchange="handleImport(event)" />
            </div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    
    <!-- Scripts -->
    <script type="module">
        import { auth, db } from "../shared/js/firebase-init.js";
        import { doc, setDoc, getDoc, updateDoc, deleteDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        let placeholders = {};
        let allUsers = {};
        let currentPage = 'all';
        let selectedUser = null;
        let placeholderStatus = {}; // Track active status of placeholders
        
        // Page-specific placeholder mapping
        const pageTemplates = {
            'index.html': ['{{fullName}}', '{{mst}}', '{{company}}', '{{currentDate}}', '{{currentTime}}'],
            'thongtin.html': ['{{fullName}}', '{{mst}}', '{{company}}', '{{address}}', '{{phone}}', '{{email}}', '{{position}}', '{{department}}', '{{bankAccount}}', '{{bankName}}', '{{registrationDate}}'],
            'dangky.html': ['{{fullName}}', '{{mst}}', '{{company}}', '{{currentDate}}'],
            'nopthue.html': ['{{fullName}}', '{{mst}}', '{{company}}', '{{bankAccount}}', '{{bankName}}', '{{currentDate}}', '{{taxAmount}}', '{{currency}}'],
            'hoadondt.html': ['{{fullName}}', '{{mst}}', '{{company}}', '{{address}}', '{{phone}}', '{{email}}', '{{currentDate}}', '{{taxRate}}', '{{currency}}'],
            'khaithue.html': ['{{mst}}', '{{fullName}}', '{{address}}', '{{phone}}', '{{email}}', '{{currentDate}}'],
            'thongtin-chitiet.html': ['{{fullName}}', '{{mst}}', '{{company}}', '{{address}}', '{{phone}}', '{{email}}', '{{position}}', '{{department}}', '{{citizenId}}', '{{taxDepartment}}', '{{businessType}}', '{{registrationDate}}', '{{businessLicense}}', '{{bankAccount}}', '{{bankName}}', '{{bankBranch}}'],
            'thaydoittdkthue.html': ['{{fullName}}', '{{mst}}', '{{company}}', '{{address}}', '{{phone}}', '{{email}}', '{{currentDate}}', '{{registrationDate}}', '{{businessLicense}}'],
            'hoso.html': ['{{fullName}}', '{{mst}}', '{{company}}', '{{currentDate}}'],
            'tra-cuu-chung-tu.html': ['{{fullName}}', '{{mst}}', '{{company}}', '{{currentDate}}'],
            'nghiavu.html': ['{{fullName}}', '{{mst}}', '{{company}}', '{{taxPeriod}}', '{{taxYear}}', '{{currentDate}}', '{{taxDepartment}}'],
            'ho-tro-qtt.html': ['{{fullName}}', '{{mst}}', '{{company}}', '{{taxPeriod}}', '{{taxYear}}', '{{currentDate}}'],
            'ho-tro-qtthue.html': ['{{fullName}}', '{{mst}}', '{{company}}', '{{taxPeriod}}', '{{taxYear}}', '{{currentDate}}'],
            'thongbao.html': ['{{fullName}}', '{{mst}}', '{{company}}', '{{currentDate}}', '{{currentTime}}'],
            'thietlap.html': ['{{fullName}}', '{{mst}}', '{{email}}', '{{phone}}', '{{currentDate}}'],
            // Add more page templates as needed
        };

        // Load users from Firebase Realtime Database
        window.loadUsers = async () => {
            try {
                // Method 1: Use Firebase SDK (preferred)
                if (typeof firebase !== 'undefined' && firebase.database) {
                    console.log('🔥 Using Firebase SDK to load users...');
                    const usersRef = firebase.database().ref('users');
                    const snapshot = await usersRef.once('value');
                    allUsers = snapshot.val() || {};
                } else {
                    // Method 2: Direct fetch as fallback
                    console.log('🌐 Using direct fetch to load users...');
                    const response = await fetch('https://etax-7fbf8-default-rtdb.asia-southeast1.firebasedatabase.app/users.json');
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    const users = await response.json();
                    allUsers = users || {};
                }
                
                // Populate user dropdown
                const userSelect = document.getElementById('testUser');
                if (!userSelect) {
                    console.error('❌ testUser dropdown not found');
                    return;
                }
                
                userSelect.innerHTML = '<option value="">Chọn user...</option>';
                
                const userCount = Object.keys(allUsers).length;
                if (userCount === 0) {
                    userSelect.innerHTML += '<option value="" disabled>Không có user nào</option>';
                    showAlert('⚠️ Không tìm thấy user nào trong database', 'warning');
                    return;
                }
                
                // Add sample user for testing if no real users
                if (userCount === 0) {
                    allUsers['123456789'] = {
                        mst: '123456789',
                        fullName: 'Nguyễn Văn Test',
                        company: 'Công ty Test',
                        address: '123 Test Street',
                        phone: '0901234567',
                        email: 'test@example.com'
                    };
                }
                
                Object.keys(allUsers).forEach(mst => {
                    const user = allUsers[mst];
                    const option = document.createElement('option');
                    option.value = mst;
                    option.textContent = `${user.fullName || user.name || 'N/A'} (${mst})`;
                    userSelect.appendChild(option);
                });
                
                console.log('✅ Loaded', Object.keys(allUsers).length, 'users');
                showAlert(`✅ Đã load ${Object.keys(allUsers).length} users`, 'success');
                
            } catch (error) {
                console.error('❌ Error loading users:', error);
                showAlert('❌ Lỗi load users: ' + error.message, 'danger');
                
                // Add fallback sample data for testing
                allUsers = {
                    '123456789': {
                        mst: '123456789',
                        fullName: 'Nguyễn Văn Test',
                        company: 'Công ty Test ABC',
                        address: '123 Nguyễn Văn A, Q1, TP.HCM',
                        phone: '0901234567',
                        email: 'test@company.com',
                        position: 'Giám đốc',
                        department: 'Kế toán',
                        bankAccount: '1234567890',
                        bankName: 'Vietcombank'
                    },
                    '987654321': {
                        mst: '987654321',
                        fullName: 'Trần Thị Demo',
                        company: 'Công ty Demo XYZ',
                        address: '456 Lê Lợi, Q3, TP.HCM',
                        phone: '0987654321',
                        email: 'demo@demo.com',
                        position: 'Kế toán trưởng',
                        department: 'Tài chính',
                        bankAccount: '0987654321',
                        bankName: 'BIDV'
                    }
                };
                
                const userSelect = document.getElementById('testUser');
                if (userSelect) {
                    userSelect.innerHTML = '<option value="">Chọn user...</option>';
                    Object.keys(allUsers).forEach(mst => {
                        const user = allUsers[mst];
                        const option = document.createElement('option');
                        option.value = mst;
                        option.textContent = `${user.fullName || user.name || 'N/A'} (${mst})`;
                        userSelect.appendChild(option);
                    });
                }
                
                console.log('✅ Using fallback sample data:', Object.keys(allUsers).length, 'users');
            }
        };

        // Load placeholders from Firestore
        window.loadPlaceholders = async () => {
            try {
                const docRef = doc(db, "system", "placeholders");
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    placeholders = docSnap.data().data || {};
                    await loadPlaceholderStatus();
                    renderPlaceholders();
                } else {
                    console.log("No placeholders found");
                }
            } catch (error) {
                console.error("Error loading placeholders:", error);
            }
        };

        // Load placeholder status (active/inactive)
        window.loadPlaceholderStatus = async () => {
            try {
                const docRef = doc(db, "system", "placeholder_status");
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    placeholderStatus = docSnap.data().data || {};
                } else {
                    placeholderStatus = {};
                }
            } catch (error) {
                console.error("Error loading placeholder status:", error);
                placeholderStatus = {};
            }
        };

        // Save placeholder status
        window.savePlaceholderStatus = async () => {
            try {
                await setDoc(doc(db, "system", "placeholder_status"), {
                    data: placeholderStatus,
                    updated_at: new Date()
                });
            } catch (error) {
                console.error("Error saving placeholder status:", error);
            }
        };

        // Save placeholders to Firestore  
        window.savePlaceholders = async () => {
            try {
                await setDoc(doc(db, "system", "placeholders"), {
                    data: placeholders,
                    updated_at: new Date()
                });
                showAlert("✅ Lưu placeholder thành công!", "success");
            } catch (error) {
                console.error("Error saving placeholders:", error);
                showAlert("❌ Lỗi lưu placeholder: " + error.message, "danger");
            }
        };

        // Add new placeholder
        window.addPlaceholder = async () => {
            const key = document.getElementById('placeholderKey').value.trim();
            const value = document.getElementById('placeholderValue').value.trim();
            const description = document.getElementById('placeholderDescription').value.trim();
            const targetPagesSelect = document.getElementById('targetPages');
            const selectedPages = Array.from(targetPagesSelect.selectedOptions).map(option => option.value);

            if (!key || !value) {
                showAlert("❌ Vui lòng nhập đầy đủ Key và Value!", "danger");
                return;
            }

            placeholders[key] = {
                value: value,
                description: description,
                pages: selectedPages.length > 0 ? selectedPages : ['all'],
                created_at: new Date().toISOString()
            };

            // Set default status as active
            placeholderStatus[key] = {
                status: 'active',
                tested_at: new Date().toISOString(),
                test_result: 'pending'
            };

            await savePlaceholders();
            await savePlaceholderStatus();
            renderPlaceholders();
            
            // Clear form
            document.getElementById('placeholderKey').value = '';
            document.getElementById('placeholderValue').value = '';
            document.getElementById('placeholderDescription').value = '';
            targetPagesSelect.selectedIndex = -1;
        };

        // Delete placeholder
        window.deletePlaceholder = async (key) => {
            if (confirm(`Xóa placeholder "${key}"?`)) {
                delete placeholders[key];
                delete placeholderStatus[key];
                await savePlaceholders();
                await savePlaceholderStatus();
                renderPlaceholders();
            }
        };

        // Edit placeholder
        window.editPlaceholder = (key) => {
            const placeholder = placeholders[key];
            document.getElementById('placeholderKey').value = key;
            document.getElementById('placeholderValue').value = placeholder.value;
            document.getElementById('placeholderDescription').value = placeholder.description || '';
        };

        // Render placeholders
        window.renderPlaceholders = () => {
            const container = document.getElementById('placeholderList');
            const statusFilter = document.getElementById('statusFilter')?.value || 'all';
            const searchFilter = document.getElementById('searchFilter')?.value.toLowerCase() || '';
            
            if (Object.keys(placeholders).length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> 
                        Chưa có placeholder nào. Hãy thêm placeholder đầu tiên!
                    </div>
                `;
                return;
            }

            let html = '';
            let filteredPlaceholders = Object.entries(placeholders);
            
            // Apply filters
            if (currentPage !== 'all') {
                filteredPlaceholders = filteredPlaceholders.filter(([key, data]) => {
                    const pages = data.pages || ['all'];
                    return pages.includes('all') || pages.includes(currentPage);
                });
            }
            
            if (statusFilter !== 'all') {
                filteredPlaceholders = filteredPlaceholders.filter(([key]) => {
                    const status = placeholderStatus[key]?.status || 'inactive';
                    return status === statusFilter;
                });
            }
            
            if (searchFilter) {
                filteredPlaceholders = filteredPlaceholders.filter(([key, data]) => {
                    return key.toLowerCase().includes(searchFilter) || 
                           data.description?.toLowerCase().includes(searchFilter) ||
                           data.value.toLowerCase().includes(searchFilter);
                });
            }
            
            if (filteredPlaceholders.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-filter"></i> 
                        Không tìm thấy placeholder nào phù hợp với bộ lọc hiện tại.
                    </div>
                `;
                return;
            }

            for (const [key, data] of filteredPlaceholders) {
                const status = placeholderStatus[key]?.status || 'inactive';
                const testResult = placeholderStatus[key]?.test_result || 'pending';
                const testedAt = placeholderStatus[key]?.tested_at;
                
                // Get current test value if user is selected
                let testValue = data.value;
                if (selectedUser && allUsers[selectedUser]) {
                    try {
                        testValue = getPlaceholderTestValue(key, allUsers[selectedUser]);
                        logDebug(`Preview for ${key}:`, testValue);
                    } catch (error) {
                        console.error('Error getting test value for', key, error);
                        testValue = 'Error: ' + error.message;
                    }
                }
                
                const pages = data.pages || ['all'];
                const pagesTags = pages.map(page => 
                    `<span class="page-tag">${page === 'all' ? '🌐 All' : page}</span>`
                ).join('');
                
                html += `
                    <div class="placeholder-item ${status}">
                        <div class="placeholder-header">
                            <div class="placeholder-key">${key}</div>
                            <div class="placeholder-status">
                                <span class="status-badge ${status}">
                                    ${status === 'active' ? '✅ Active' : 
                                      status === 'error' ? '⚠️ Error' : '❌ Inactive'}
                                </span>
                                <button class="btn test-button" onclick="testSinglePlaceholder('${key}')">
                                    <i class="fas fa-play"></i> Test
                                </button>
                            </div>
                        </div>
                        
                        <div class="placeholder-value"><strong>Giá trị mặc định:</strong> ${data.value}</div>
                        
                        ${selectedUser && allUsers[selectedUser] ? `
                            <div class="placeholder-test-value">
                                <strong>Test với user ${allUsers[selectedUser]?.fullName || allUsers[selectedUser]?.name || selectedUser}:</strong><br>
                                <code>${testValue}</code>
                            </div>
                        ` : selectedUser ? `
                            <div class="placeholder-test-value" style="background: #fff3cd; border: 1px solid #ffeaa7;">
                                <strong>⚠️ User data không tìm thấy cho: ${selectedUser}</strong>
                            </div>
                        ` : ''}
                        
                        ${data.description ? `<div class="text-muted"><strong>Mô tả:</strong> ${data.description}</div>` : ''}
                        
                        <div class="placeholder-pages">
                            <strong>Áp dụng cho:</strong> ${pagesTags}
                        </div>
                        
                        ${testedAt ? `
                            <div style="font-size: 0.85em; color: #666; margin-bottom: 10px;">
                                <strong>Test cuối:</strong> ${new Date(testedAt).toLocaleString('vi-VN')}
                                <strong>Kết quả:</strong> ${testResult === 'success' ? '✅ Thành công' : testResult === 'error' ? '❌ Lỗi' : '⏳ Chưa test'}
                            </div>
                        ` : ''}
                        
                        <div class="placeholder-actions">
                            <button class="btn" onclick="editPlaceholder('${key}')">
                                <i class="fas fa-edit"></i> Sửa
                            </button>
                            <button class="btn btn-danger" onclick="deletePlaceholder('${key}')">
                                <i class="fas fa-trash"></i> Xóa
                            </button>
                            <button class="btn ${status === 'active' ? 'btn-warning' : 'btn-success'}" 
                                    onclick="togglePlaceholderStatus('${key}')">
                                <i class="fas fa-power-off"></i> 
                                ${status === 'active' ? 'Tắt' : 'Bật'}
                            </button>
                        </div>
                    </div>
                `;
            }
            container.innerHTML = html;
        };

        // Load sample data with page assignments
        window.loadSampleData = async () => {
            try {
                placeholders = {
                    "{{fullName}}": { 
                        value: "Nguyễn Văn A", 
                        description: "Họ tên người dùng",
                        pages: ['index.html', 'thongtin.html', 'dangky.html', 'nopthue.html'],
                        created_at: new Date().toISOString()
                    },
                    "{{mst}}": { 
                        value: "0123456789", 
                        description: "Mã số thuế",
                        pages: ['all'],
                        created_at: new Date().toISOString()
                    },
                    "{{company}}": { 
                        value: "Công ty TNHH ABC", 
                        description: "Tên công ty",
                        pages: ['index.html', 'thongtin.html', 'dangky.html', 'nopthue.html'],
                        created_at: new Date().toISOString()
                    },
                    "{{address}}": { 
                        value: "123 Nguyễn Văn A, Quận 1, TP.HCM", 
                        description: "Địa chỉ công ty",
                        pages: ['thongtin.html', 'hoadondt.html'],
                        created_at: new Date().toISOString()
                    },
                    "{{phone}}": { 
                        value: "0901234567", 
                        description: "Số điện thoại",
                        pages: ['thongtin.html', 'hoadondt.html', 'thietlap.html'],
                        created_at: new Date().toISOString()
                    },
                    "{{email}}": { 
                        value: "contact@company.com", 
                        description: "Email liên hệ",
                        pages: ['thongtin.html', 'hoadondt.html', 'thietlap.html'],
                        created_at: new Date().toISOString()
                    },
                    "{{currentDate}}": { 
                        value: new Date().toLocaleDateString('vi-VN'), 
                        description: "Ngày hiện tại",
                        pages: ['all'],
                        created_at: new Date().toISOString()
                    },
                    "{{currentTime}}": { 
                        value: new Date().toLocaleTimeString('vi-VN'), 
                        description: "Giờ hiện tại",
                        pages: ['index.html', 'thongbao.html'],
                        created_at: new Date().toISOString()
                    }
                };
                
                // Initialize status for all sample placeholders
                Object.keys(placeholders).forEach(key => {
                    placeholderStatus[key] = {
                        status: 'active',
                        tested_at: new Date().toISOString(),
                        test_result: 'success'
                    };
                });
                
                await savePlaceholders();
                await savePlaceholderStatus();
                renderPlaceholders();
                
                showAlert('✅ Đã load dữ liệu mẫu với 8 placeholder chuẩn', 'success');
                
            } catch (error) {
                console.error('Error loading sample data:', error);
                showAlert('❌ Lỗi load dữ liệu mẫu: ' + error.message, 'danger');
            }
        };

        // Export placeholders
        window.exportPlaceholders = () => {
            const dataStr = JSON.stringify(placeholders, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = 'etax-placeholders.json';
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        };

        // Import placeholders
        window.importPlaceholders = () => {
            document.getElementById('importFile').click();
        };

        window.handleImport = (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const imported = JSON.parse(e.target.result);
                        placeholders = { ...placeholders, ...imported };
                        await savePlaceholders();
                        renderPlaceholders();
                        showAlert("✅ Import thành công!", "success");
                    } catch (error) {
                        showAlert("❌ Lỗi import file: " + error.message, "danger");
                    }
                };
                reader.readAsText(file);
            }
        };

        // Clear all placeholders
        window.clearAllPlaceholders = async () => {
            if (confirm("Xóa tất cả placeholders? Hành động này không thể hoàn tác!")) {
                placeholders = {};
                await savePlaceholders();
                renderPlaceholders();
            }
        };

        // Show alert with better positioning
        window.showAlert = (message, type) => {
            // Remove existing alerts first
            document.querySelectorAll('.temp-alert').forEach(el => el.remove());
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} temp-alert`;
            alertDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>${message}</span>
                    <button type="button" style="background: none; border: none; font-size: 18px; cursor: pointer;" onclick="this.parentElement.parentElement.remove()">&times;</button>
                </div>
            `;
            
            // Insert at top of container
            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.firstChild);
            
            // Auto remove after 8 seconds
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 8000);
        };
        
        // Add console logging for debugging
        window.logDebug = (message, data = null) => {
            const timestamp = new Date().toLocaleTimeString();
            console.log(`[${timestamp}] ${message}`, data);
        };

        // Get test value for placeholder with specific user data
        window.getPlaceholderTestValue = (placeholder, userData) => {
            if (!userData) {
                console.warn('⚠️ No user data provided for', placeholder);
                return placeholders[placeholder]?.value || 'N/A';
            }
            
            // Remove braces from placeholder
            const field = placeholder.replace(/[{}]/g, '');
            
            // Handle special cases
            switch (field) {
                case 'currentDate':
                    return new Date().toLocaleDateString('vi-VN');
                case 'currentYear':
                    return new Date().getFullYear().toString();
                case 'currentMonth':
                    return (new Date().getMonth() + 1).toString();
                case 'currentDay':
                    return new Date().getDate().toString();
                case 'currentTime':
                    return new Date().toLocaleTimeString('vi-VN');
                case 'currency':
                    return 'VNĐ';
                case 'taxRate':
                    return '5%';
                case 'taxPeriod':
                    return 'Q4/2024';
                case 'taxYear':
                    return '2024';
                case 'taxAmount':
                    return '1,000,000 VNĐ';
                case 'taxDepartment':
                    return 'Chi cục thuế Quận 1';
                case 'businessType':
                    return 'Công ty TNHH';
                case 'registrationDate':
                    return '15/03/2020';
                case 'businessLicense':
                    return 'GP123456789';
                case 'citizenId':
                    return '123456789012';
                case 'bankBranch':
                    return 'Chi nhánh TP.HCM';
                default:
                    // Try user data first, then fallback to placeholder default
                    const value = userData[field] || userData[field.toLowerCase()] || placeholders[placeholder]?.value;
                    return value || 'N/A';
            }
        };

        // Test single placeholder
        window.testSinglePlaceholder = async (placeholderKey) => {
            try {
                const testUser = selectedUser || Object.keys(allUsers)[0];
                if (!testUser) {
                    showAlert('❌ Chưa có user để test!', 'warning');
                    return;
                }
                
                const userData = allUsers[testUser];
                const testValue = getPlaceholderTestValue(placeholderKey, userData);
                
                // Update status
                placeholderStatus[placeholderKey] = {
                    status: testValue !== 'N/A' && testValue !== '' ? 'active' : 'error',
                    tested_at: new Date().toISOString(),
                    test_result: testValue !== 'N/A' && testValue !== '' ? 'success' : 'error',
                    test_value: testValue
                };
                
                await savePlaceholderStatus();
                renderPlaceholders();
                
                showAlert(`✅ Test ${placeholderKey}: ${testValue}`, 'success');
                
            } catch (error) {
                console.error('Error testing placeholder:', error);
                showAlert('❌ Lỗi test placeholder: ' + error.message, 'danger');
            }
        };

        // Test all placeholders
        window.testAllPlaceholders = async () => {
            if (!selectedUser) {
                showAlert('❌ Vui lòng chọn user để test!', 'warning');
                return;
            }
            
            const userData = allUsers[selectedUser];
            let successCount = 0;
            let errorCount = 0;
            
            for (const [key] of Object.entries(placeholders)) {
                const testValue = getPlaceholderTestValue(key, userData);
                const isSuccess = testValue !== 'N/A' && testValue !== '';
                
                placeholderStatus[key] = {
                    status: isSuccess ? 'active' : 'error',
                    tested_at: new Date().toISOString(),
                    test_result: isSuccess ? 'success' : 'error',
                    test_value: testValue
                };
                
                if (isSuccess) successCount++;
                else errorCount++;
            }
            
            await savePlaceholderStatus();
            renderPlaceholders();
            
            showAlert(`✅ Test hoàn thành: ${successCount} thành công, ${errorCount} lỗi`, 'info');
        };

        // Toggle placeholder status
        window.togglePlaceholderStatus = async (placeholderKey) => {
            const currentStatus = placeholderStatus[placeholderKey]?.status || 'inactive';
            const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
            
            placeholderStatus[placeholderKey] = {
                ...placeholderStatus[placeholderKey],
                status: newStatus,
                updated_at: new Date().toISOString()
            };
            
            await savePlaceholderStatus();
            renderPlaceholders();
            
            showAlert(`✅ ${placeholderKey} đã ${newStatus === 'active' ? 'bật' : 'tắt'}`, 'success');
        };

        // Filter placeholders
        window.filterPlaceholders = () => {
            renderPlaceholders();
        };

        // Load page placeholders
        window.loadPagePlaceholders = () => {
            const pageSelect = document.getElementById('targetPage');
            currentPage = pageSelect.value;
            
            // Update display
            document.getElementById('currentPageDisplay').textContent = 
                currentPage === 'all' ? 'Tất cả trang' : currentPage;
            
            renderPlaceholders();
        };

        // Preview placeholders with selected user
        window.previewPlaceholders = () => {
            const userSelect = document.getElementById('testUser');
            selectedUser = userSelect.value;
            
            if (selectedUser) {
                console.log('👤 Selected user:', selectedUser, allUsers[selectedUser]?.fullName);
                showAlert(`👤 Đã chọn user: ${allUsers[selectedUser]?.fullName || selectedUser}`, 'info');
            } else {
                console.log('❌ No user selected');
            }
            
            renderPlaceholders();
        };

        // Refresh users
        window.refreshUsers = async () => {
            try {
                console.log('🔄 Refreshing users...');
                await loadUsers();
                // Reset selected user
                selectedUser = null;
                document.getElementById('testUser').value = '';
                renderPlaceholders();
                showAlert('✅ Đã cập nhật danh sách user', 'success');
            } catch (error) {
                console.error('❌ Error refreshing users:', error);
                showAlert('❌ Lỗi refresh users: ' + error.message, 'danger');
            }
        };
        
        // Debug function to check system status
        window.debugSystem = () => {
            console.log('=== PLACEHOLDER SYSTEM DEBUG ===');
            console.log('Firebase available:', typeof firebase !== 'undefined');
            console.log('Firebase database:', firebase?.database ? 'Available' : 'Not available');
            console.log('All users loaded:', Object.keys(allUsers).length);
            console.log('Selected user:', selectedUser);
            console.log('Current page:', currentPage);
            console.log('Placeholders count:', Object.keys(placeholders).length);
            console.log('User data:', selectedUser ? allUsers[selectedUser] : 'None');
            
            const debugInfo = {
                firebase: typeof firebase !== 'undefined',
                database: firebase?.database ? true : false,
                usersCount: Object.keys(allUsers).length,
                selectedUser,
                currentPage,
                placeholdersCount: Object.keys(placeholders).length,
                allUsers: Object.keys(allUsers),
                userData: selectedUser ? allUsers[selectedUser] : null
            };
            
            showAlert(`🐛 Debug Info: 
• Firebase: ${debugInfo.firebase ? '✅' : '❌'}
• Users: ${debugInfo.usersCount}
• Selected: ${debugInfo.selectedUser || 'None'}
• Page: ${debugInfo.currentPage}
• Placeholders: ${debugInfo.placeholdersCount}`, 'info');
            
            return debugInfo;
        };
        
        // Test preview functionality specifically
        window.testPreview = () => {
            if (!selectedUser) {
                showAlert('⚠️ Chọn user trước để test preview!', 'warning');
                return;
            }
            
            const userData = allUsers[selectedUser];
            if (!userData) {
                showAlert('❌ Không tìm thấy dữ liệu cho user: ' + selectedUser, 'danger');
                return;
            }
            
            // Test a few key placeholders
            const testPlaceholders = ['{{fullName}}', '{{mst}}', '{{company}}', '{{currentDate}}'];
            const results = testPlaceholders.map(ph => {
                const value = getPlaceholderTestValue(ph, userData);
                return `${ph}: ${value}`;
            });
            
            showAlert(`👤 Preview test với ${userData.fullName || selectedUser}:\n${results.join('\n')}`, 'success');
            
            // Force re-render to show preview
            renderPlaceholders();
        };

        // Show page template
        window.showPageTemplate = () => {
            if (currentPage === 'all') {
                showAlert('⚠️ Vui lòng chọn trang cụ thể', 'warning');
                return;
            }
            
            const recommendedPlaceholders = pageTemplates[currentPage] || [];
            const templateHtml = recommendedPlaceholders.map(p => 
                `<span style="background: #e3f2fd; padding: 2px 6px; border-radius: 4px; margin: 2px;">${p}</span>`
            ).join(' ');
            
            const template = `
                <div class="template-code">
<strong>Placeholder đề xuất cho ${currentPage}:</strong><br><br>
${recommendedPlaceholders.map(p => `${p}`).join('\n')}<br><br>
<strong>HTML template:</strong><br>
${recommendedPlaceholders.map(p => `<span>Giá trị: ${p}</span>`).join('\n')}
                </div>
            `;
            
            const modal = document.createElement('div');
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;" onclick="this.remove()">
                    <div style="background: white; padding: 30px; border-radius: 10px; max-width: 80%; max-height: 80%; overflow-y: auto;" onclick="event.stopPropagation()">
                        <h3>Template cho ${currentPage}</h3>
                        ${template}
                        <br>
                        <button class="btn btn-danger" onclick="this.closest('div').remove()">
                            <i class="fas fa-times"></i> Đóng
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        };

        // Test page placeholders
        window.testPagePlaceholders = async () => {
            if (currentPage === 'all') {
                showAlert('⚠️ Vui lòng chọn trang cụ thể', 'warning');
                return;
            }
            
            if (!selectedUser) {
                showAlert('❌ Vui lòng chọn user để test!', 'warning');
                return;
            }
            
            const recommendedPlaceholders = pageTemplates[currentPage] || [];
            const userData = allUsers[selectedUser];
            let results = [];
            
            for (const placeholder of recommendedPlaceholders) {
                const testValue = getPlaceholderTestValue(placeholder, userData);
                results.push(`${placeholder}: ${testValue}`);
                
                if (placeholders[placeholder]) {
                    placeholderStatus[placeholder] = {
                        status: testValue !== 'N/A' && testValue !== '' ? 'active' : 'error',
                        tested_at: new Date().toISOString(),
                        test_result: testValue !== 'N/A' && testValue !== '' ? 'success' : 'error',
                        test_value: testValue
                    };
                }
            }
            
            await savePlaceholderStatus();
            renderPlaceholders();
            
            showAlert(`✅ Test ${currentPage} hoàn thành:\n${results.join('\n')}`, 'success');
        };

        // Populate target pages dropdown
        window.populateTargetPages = () => {
            const select = document.getElementById('targetPages');
            if (!select) return;
            
            select.innerHTML = Object.keys(pageTemplates).map(page => 
                `<option value="${page}">${page}</option>`
            ).join('');
        };

        // Initialize Firebase and load data
        window.initializeSystem = async () => {
            try {
                console.log('🚀 Initializing Placeholder System...');
                
                // Wait for Firebase to be ready
                let retries = 0;
                while ((!firebase || !firebase.database) && retries < 10) {
                    console.log('⏳ Waiting for Firebase...', retries);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    retries++;
                }
                
                if (!firebase || !firebase.database) {
                    console.warn('⚠️ Firebase not available, using fallback mode');
                }
                
                // Load data in sequence
                await loadPlaceholders();
                await loadUsers();
                populateTargetPages();
                
                console.log('✅ Placeholder System initialized successfully');
                
            } catch (error) {
                console.error('❌ Error initializing system:', error);
                showAlert('❌ Lỗi khởi tạo hệ thống: ' + error.message, 'danger');
            }
        };
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Add small delay to ensure Firebase is loaded
            setTimeout(initializeSystem, 1000);
        });
        
        // Also initialize when Firebase becomes available
        window.addEventListener('load', () => {
            if (typeof firebase !== 'undefined') {
                setTimeout(initializeSystem, 500);
            }
        });
    </script>
</body>
</html>