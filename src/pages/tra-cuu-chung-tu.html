<!DOCTYPE html>
<html lang="vi">
<head>
  <script src="/src/services/auth-guard.min.js"></script>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Tra cứu chứng từ - eTax Mobile</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <style>
    :root { --red: #b71c1c; --muted:#f8f8f8; }
    * { box-sizing: border-box; -webkit-font-smoothing:antialiased; }
    html,body { margin:0; padding:0; background:#fff; font-family: 'Helvetica Neue', Arial, sans-serif; -webkit-text-size-adjust:100%; }
    .phone-frame { width:100vw; min-height:100vh; }

    .header{
      background: var(--red);
      color:#fff;
      height:100px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 0 20px;
      position:fixed;
      left:0; right:0; top:0; z-index: 1200;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      padding-top: max(12px, env(safe-area-inset-top));
    }
    .header .header-title { font-size:20px; font-weight:500; text-align:center; flex:1; }

    main.content {
      padding: 110px 12px 40px;
      width:100%;
      min-height: calc(100vh - 110px);
    }

    /* Date input styling */
    .date-input-group {
      margin-bottom: 20px;
    }
    .date-field {
      position: relative;
      margin-bottom: 12px;
    }
    .date-label {
      display: block;
      color: #333;
      font-size: 14px;
      margin-bottom: 6px;
      font-weight: 500;
    }
    .date-label::after {
      content: " *";
      color: var(--red);
    }
    .date-input {
      width: 100%;
      padding: 12px 40px 12px 12px;
      border-radius: 8px;
      border: 1px solid #ddd;
      font-size: 15px;
      background: #fff;
      color: #333;
    }
    .date-input:focus {
      outline: none;
      border-color: var(--red);
      box-shadow: 0 0 0 2px rgba(183, 28, 28, 0.1);
    }
    .calendar-icon {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #666;
      font-size: 16px;
      pointer-events: none;
    }
    .date-field:first-child .calendar-icon {
      top: calc(50% + 10px);
    }

    .btn-search { 
      background: var(--red); 
      color:#fff; 
      border:none; 
      padding:14px 20px; 
      border-radius:8px; 
      font-weight:600; 
      font-size:16px;
      width:100%; 
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .btn-search:hover {
      background: #a01515;
    }

    /* Bảng kết quả */
    .result-table {
      margin-top: 18px;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #ccc;
    }
    .result-table table {
      width:100%;
      border-collapse: collapse;
      table-layout: fixed;
      font-size:14px;
    }
    .result-table col.col-ref { width: 20%; }
    .result-table col.col-amount { width: 15%; }
    .result-table col.col-date { width: 25%; }
    .result-table col.col-status { width: 30%; }
    .result-table col.col-print { width: 10%; }

    .result-table thead th {
      background: #f3f3f3;
      color:#333;
      font-size:12px;
      padding: 10px 6px;
      border: 1px solid #ccc;
      font-weight:700;
      text-align:center;
      vertical-align: middle;
    }
    .result-table tbody td {
      padding: 12px 6px;
      border: 1px solid #ccc;
      vertical-align: middle;
      word-break: break-word;
      font-size:14px;
      text-align:center;
      line-height:1.25;
    }
    .result-table tbody td.ref {
      text-align:center;
      font-size:13px;
      white-space: normal;
      line-height: 1.3;
    }
    .result-table tbody td.amount { 
      color: #333; 
      font-weight:600; 
      text-align:center;
    }
    .result-table tbody td.date { 
      font-size:13px; 
      text-align:center;
      line-height: 1.3;
    }
    .result-table tbody td.status { 
      font-size:13px; 
      color:#333; 
      text-align:left; 
      padding-left:8px; 
      line-height:1.2; 
    }

    /* Nút tròn in nhỏ hơn */
    .print-btn {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:24px;
      height:24px;
      border-radius:50%;
      border:2px solid var(--red);
      background:transparent;
      color:var(--red);
      cursor:pointer;
      font-weight:700;
      font-size:12px;
    }

    /* Nút in ở dưới cùng */
    .btn-print-bottom {
      background: var(--red);
      color: #fff;
      border: none;
      padding: 14px 20px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 16px;
      width: 100%;
      margin-top: 20px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .btn-print-bottom:hover {
      background: #a01515;
    }

    /* Popup */
    .download-popup {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.45);
      z-index: 1500;
      backdrop-filter: blur(2px);
    }
    .popup-content {
      width: min(360px, 92%);
      background: #fff;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 18px 40px rgba(0,0,0,0.35);
      text-align: center;
    }
    .popup-body { padding: 22px 22px 16px; }
    .popup-title { font-size: 20px; font-weight:700; color:#111; margin-bottom:8px; }
    .popup-sub { font-size:18px; color:#333; margin-bottom:6px; }
    .popup-actions {
      display:flex;
      border-top: 2px solid rgba(183,28,28,0.08);
      background: #fff;
    }
    .popup-actions button {
      flex:1;
      padding: 16px 10px;
      border: none;
      background: transparent;
      font-size: 17px;
      font-weight:700;
      color: var(--red);
      cursor: pointer;
    }
    .popup-actions button:not(:last-child) {
      border-right: 1px solid rgba(0,0,0,0.06);
    }

    @media (max-width:420px){
      .result-table thead th { font-size:11px; padding:8px 4px; }
      .result-table tbody td { padding:8px 4px; font-size:12px; }
      .print-btn { width:24px; height:24px; font-size:12px; }
      .popup-title { font-size:18px; }
      .popup-sub { font-size:16px; }
    }
  </style>
</head>
<body>
  <div class="phone-frame">
    <header class="header">
      <i class="fas fa-arrow-left" onclick="goBack()" style="font-size:20px; cursor:pointer;"></i>
      <div class="header-title">Tra cứu chứng từ</div>
      <i class="fas fa-house" onclick="goHome()" style="font-size:20px;"></i>
    </header>

    <main class="content">
      <form id="searchForm" onsubmit="return false;">
        <div class="date-input-group">
          <div class="date-field">
            <input type="date" id="fromDate" class="date-input" placeholder="11/10/2024">
            <i class="fas fa-calendar-alt calendar-icon"></i>
          </div>
          <div class="date-field">
            <label class="date-label">Đến ngày *</label>
            <input type="date" id="toDate" class="date-input" placeholder="11/10/2025" readonly>
            <i class="fas fa-calendar-alt calendar-icon"></i>
          </div>
        </div>
        <button type="button" class="btn-search" onclick="searchDocuments()">Tra cứu</button>
      </form>

      <div class="result-table" id="resultsTable" style="display:none;">
        <table>
          <colgroup>
            <col class="col-ref">
            <col class="col-amount">
            <col class="col-date">
            <col class="col-status">
            <col class="col-print">
          </colgroup>
          <thead>
            <tr>
              <th>Mã tham chiếu</th>
              <th>Số tiền</th>
              <th>Ngày nộp</th>
              <th>Trạng thái</th>
              <th>In chứng từ</th>
            </tr>
          </thead>
          <tbody id="resultsBody"></tbody>
        </table>
      </div>

      <button class="btn-print-bottom" id="printBottomBtn" style="display:none;" onclick="printAllDocuments()">In chứng từ</button>
    </main>
  </div>

  <div class="download-popup" id="downloadPopup" aria-hidden="true">
    <div class="popup-content" role="dialog" aria-modal="true">
      <div class="popup-body">
        <div class="popup-title">Bạn có muốn tải tập tin?</div>
        <div class="popup-sub">Tải ngay!</div>
      </div>
      <div class="popup-actions">
        <button type="button" onclick="cancelDownload()">Bỏ qua</button>
        <button type="button" onclick="confirmDownload()">Đồng ý</button>
      </div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD_rJgBFgBulheVenQUE2KXr4PBpSpTCxw",
      authDomain: "etax-7fbf8.firebaseapp.com",
      databaseURL: "https://etax-7fbf8-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "etax-7fbf8",
      storageBucket: "etax-7fbf8.appspot.com",
      messagingSenderId: "1030026724634",
      appId: "1:1030026724634:web:d76f5f9dad43bad6fd58a3",
      measurementId: "G-YS5DLECJE6"
    };
    try { firebase.initializeApp(firebaseConfig); } catch(e){}
    const db = firebase.database ? firebase.database() : null;

    let searchResults = [];
    let pendingDownloadId = null;

    document.addEventListener('DOMContentLoaded', function(){
      setDefaultDateRange();
      setupDateValidation();
    });

    function goBack(){ if(window.history.length>1) window.history.back(); else window.location.href='/src/pages/index.html'; }
    function goHome(){ window.location.href='/src/pages/index.html'; }

    function setDefaultDateRange(){
      const now = new Date();
      const vn = new Date(now.toLocaleString("en-US", { timeZone: "Asia/Ho_Chi_Minh" }));
      const yyyy = vn.getFullYear();
      const mm = String(vn.getMonth()+1).padStart(2,'0');
      const dd = String(vn.getDate()).padStart(2,'0');
      const today = `${yyyy}-${mm}-${dd}`;
      document.getElementById('fromDate').value = today;
      document.getElementById('toDate').value = today;
    }

    function setupDateValidation(){
      const fromDate = document.getElementById('fromDate');
      const toDate = document.getElementById('toDate');
      const now = new Date();
      const vn = new Date(now.getTime() + (7*60 - now.getTimezoneOffset())*60000);
      const today = vn.toISOString().split('T')[0];
      const twoYearsAgo = new Date(vn); twoYearsAgo.setFullYear(vn.getFullYear()-2);
      const minDate = twoYearsAgo.toISOString().split('T')[0];
      fromDate.max = today; fromDate.min = minDate;
      toDate.max = today; toDate.min = today;
      toDate.readOnly = true;
      toDate.style.backgroundColor = '#f5f5f5';
      toDate.style.cursor = 'not-allowed';
      fromDate.addEventListener('change', validateDateRange);
    }

    function validateDateRange(){
      const f = document.getElementById('fromDate').value;
      const t = document.getElementById('toDate').value;
      if(!f||!t) return true;
      const from = new Date(f), to = new Date(t);
      const now = new Date(), vn = new Date(now.getTime() + (7*60 - now.getTimezoneOffset())*60000);
      const today = new Date(vn.toISOString().split('T')[0]);
      const twoYearsAgo = new Date(vn); twoYearsAgo.setFullYear(vn.getFullYear()-2);
      if (from > to) { alert('❌ Ngày bắt đầu không thể lớn hơn ngày kết thúc'); return false; }
      const diffDays = Math.ceil(Math.abs(to-from)/(1000*60*60*24));
      if (diffDays > (365*2)) { alert('❌ Khoảng thời gian tra cứu không được vượt quá 2 năm'); return false; }
      if (from < twoYearsAgo || to > today) { alert('❌ Thời gian tra cứu chỉ được phép trong vòng 2 năm gần nhất'); return false; }
      return true;
    }

    async function searchDocuments(){
      if (!validateDateRange()) return;
      document.getElementById('resultsTable').style.display = 'none';
      setTimeout(()=>{
        const mockData = [
          {
            id: 'cert_11020250025364806',
            referenceNumber: '110202\n50044\n818128',
            amount: '9600',
            paymentDate: new Date('2025-10-11T12:36:52'),
            status: 'Thành công – NH/TGTT đã trừ\ntiền thành công',
            pdfLink: 'mockup.pdf'
          }
        ];
        searchResults = mockData;
        displayResults(mockData);
      }, 600);
    }

    function displayResults(docs){
      const tbody = document.getElementById('resultsBody');
      const resultsTable = document.getElementById('resultsTable');
      const printBottomBtn = document.getElementById('printBottomBtn');
      tbody.innerHTML = '';
      docs.forEach(doc=>{
        const amt = formatAmount(doc.amount);
        const dt = formatDateTime(doc.paymentDate);
        const refHtml = doc.referenceNumber.replace(/\n/g, '<br/>');
        const tr = document.createElement('tr');
        const statusHtml = doc.status.replace(/\n/g, '<br/>');
        tr.innerHTML = `
          <td class="ref">${refHtml}</td>
          <td class="amount">${amt}</td>
          <td class="date">${dt}</td>
          <td class="status">${statusHtml}</td>
          <td class="print">
            <button class="print-btn" title="In chứng từ" data-id="${doc.id}">◉</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      document.querySelectorAll('.print-btn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = btn.getAttribute('data-id');
          printDocument(id);
        });
      });
      resultsTable.style.display = 'block';
      printBottomBtn.style.display = 'block';
    }

    function formatDateTime(d){
      if(!d) return '';
      const date = new Date(d);
      const dd = String(date.getDate()).padStart(2,'0');
      const mm = String(date.getMonth()+1).padStart(2,'0');
      const yyyy = date.getFullYear();
      const hh = String(date.getHours()).padStart(2,'0');
      const min = String(date.getMinutes()).padStart(2,'0');
      const ss = String(date.getSeconds()).padStart(2,'0');
      return `${dd}/${mm}/${yyyy}<br/>${hh}:${min}:${ss}`;
    }
    function formatAmount(amount){
      if(amount==null) return '0';
      const num = Number(String(amount).replace(/[^0-9\-\.]/g,''));
      if(isNaN(num)) return amount;
      return num.toLocaleString('vi-VN');
    }

    function printDocument(documentId){
      pendingDownloadId = documentId;
      const popup = document.getElementById('downloadPopup');
      popup.style.display = 'flex';
      popup.setAttribute('aria-hidden','false');
    }
    function cancelDownload(){
      pendingDownloadId = null;
      const popup = document.getElementById('downloadPopup');
      popup.style.display = 'none';
      popup.setAttribute('aria-hidden','true');
    }
    function confirmDownload(){
      const popup = document.getElementById('downloadPopup');
      popup.style.display = 'none';
      popup.setAttribute('aria-hidden','true');
      if(!pendingDownloadId) return;
      alert('Bắt đầu tải tài liệu: ' + pendingDownloadId);
      console.log('Downloading document:', pendingDownloadId);
      pendingDownloadId = null;
    }

    function printAllDocuments(){
      if(searchResults.length === 0) {
        alert('Không có chứng từ nào để in');
        return;
      }
      alert(`Bắt đầu in ${searchResults.length} chứng từ`);
      console.log('Printing all documents:', searchResults);
    }
  </script>
</body>
</html>

