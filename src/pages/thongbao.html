<!DOCTYPE html>
<html lang="vi">
<head>
  <script src="/src/services/auth-guard.min.js"></script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>eTax Mobile - Tra cứu thông báo</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
    
    body, html { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; background-color: #f4f4f9; }
    .header {
        background-color: #b71c1c; color: white; padding: 15px 20px;
        display: flex; align-items: center; justify-content: space-between;
        position: sticky; top: 0; z-index: 1000;
    }
    .header-title { font-size: 18px; font-weight: 500; }

    /* Tabs Section */
    .tabs {
        display: flex;
        background: #ff5722; /* màu cam */
        padding: 5px;
    }
    .tab {
        flex: 1;
        text-align: left; /* để badge bên trái dễ đọc */
        color: white;
        padding: 8px 10px;
        cursor: pointer;
        position: relative;
        display: flex;
        align-items: center;
        gap: 8px; /* khoảng cách badge và chữ */
        border-radius: 6px;
    }
    .tab.active {
        background: rgba(255,255,255,0.3);
    }
    /* Badge trái */
    .badge-left {
        background: #d9534f;
        color: white;
        min-width: 18px;
        height: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        font-size: 12px;
        font-weight: bold;
    }
    /* Search */
    .search {
        display: flex; gap: 10px; padding: 10px;
        background: #fff; border-bottom: 1px solid #eee;
    }
    .search input {
        flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 6px;
    }
    .search button {
        background: none;
        color: #a00000;
        border: none;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 4px;
        cursor: pointer;
    }
    
    /* Advanced Search */
    .advanced-search {
        background: #f8f9fa;
        padding: 15px;
        border-bottom: 1px solid #eee;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        align-items: end;
    }
    
    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    
    .filter-group label {
        font-size: 12px;
        font-weight: 600;
        color: #666;
    }
    
    .filter-group select,
    .filter-group input[type="date"] {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }
    
    .clear-btn {
        background: #6c757d;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        align-self: end;
    }
    
    .clear-btn:hover {
        background: #5a6268;
    }
    /* Notifications */
    .notifications { padding: 10px; }
    .time { color: #666; font-size: 12px; margin-bottom: 4px; }
    .item {
        background: white; padding: 10px;
        border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        display: block; text-decoration: none;
        color: #333; margin-bottom: 10px;
    }
    
    /* Notification styles */
    .notification-item-wrapper {
        margin-bottom: 15px;
    }
    
    .notification-time-standalone {
        color: #666;
        font-size: 12px;
        margin-bottom: 5px;
        font-weight: 500;
    }
    
    .notification-item {
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        display: block;
        text-decoration: none;
        color: #333;
        transition: all 0.3s ease;
        border-left: 4px solid #ff5722;
        position: relative;
    }
    
    .notification-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .notification-title {
        font-weight: 600;
        font-size: 16px;
        margin-bottom: 8px;
        color: #333;
        line-height: 1.4;
    }
    
    .notification-content {
        font-size: 14px;
        color: #666;
        line-height: 1.5;
        margin-top: 8px;
    }
    
    /* Category badges */
    .notification-category {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 500;
        margin-top: 8px;
    }
    
    .category-payment { background: #e8f5e8; color: #2e7d32; }
    .category-system { background: #fff3e0; color: #f57c00; }
    .category-account { background: #e3f2fd; color: #1976d2; }
    .category-tax_obligation { background: #fce4ec; color: #c2185b; }
    .category-update { background: #f3e5f5; color: #7b1fa2; }
    
    /* Unread indicator */
    .notification-item.unread {
        border-left-color: #d32f2f;
        background: #fff5f5;
    }
    
    .notification-item.unread::before {
        content: '';
        position: absolute;
        top: 15px;
        right: 15px;
        width: 8px;
        height: 8px;
        background: #d32f2f;
        border-radius: 50%;
    }

    /* Red dot indicator for "view more" */
    .notification-item::after {
        content: '';
        position: absolute;
        top: 15px;
        right: 15px;
        width: 10px;
        height: 10px;
        background: #d32f2f;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s ease;
        z-index: 10;
    }

    .notification-item:hover::after {
        transform: scale(1.2);
        box-shadow: 0 0 8px rgba(211, 47, 47, 0.5);
    }

</style>
</head>
<body>

<header class="header">
    <i class="fas fa-arrow-left" onclick="history.back()"></i>
    <div class="header-title">Tra cứu thông báo</div>
    <i class="fas fa-house" onclick="history.back()" ></i>
</header>

<div class="tabs">
    <div class="tab active">
        <span class="badge-left">0</span>
        <div>Thông báo<br>hành chính của<br>CQT</div>
    </div>
    <div class="tab">
        <span class="badge-left">0</span>
        <div>Biến động<br>nghĩa vụ thuế</div>
    </div>
    <div class="tab">
        <span class="badge-left">0</span>
        <div>Thông báo<br>khác</div>
    </div>
</div>

<div class="search">
    <input type="text" id="searchInput" placeholder="Tìm theo nội dung hoặc ngày" onkeyup="filterNotifications()">
    <button onclick="toggleAdvancedSearch()"><i class="fas fa-plus"></i> Nâng cao</button>
</div>

<div id="advancedSearch" class="advanced-search" style="display: none;">
    <div class="filter-group">
        <label>Loại thông báo:</label>
        <select id="typeFilter" onchange="filterNotifications()">
            <option value="">Tất cả</option>
            <option value="general">Thông báo chung</option>
            <option value="personal">Thông báo cá nhân</option>
        </select>
    </div>
    <div class="filter-group">
        <label>Danh mục:</label>
        <select id="categoryFilter" onchange="filterNotifications()">
            <option value="">Tất cả</option>
            <option value="payment">Thanh toán</option>
            <option value="system">Hệ thống</option>
            <option value="account">Tài khoản</option>
            <option value="tax_obligation">Nghĩa vụ thuế</option>
            <option value="update">Cập nhật</option>
        </select>
    </div>
    <div class="filter-group">
        <label>Từ ngày:</label>
        <input type="date" id="dateFrom" onchange="filterNotifications()">
    </div>
    <div class="filter-group">
        <label>Đến ngày:</label>
        <input type="date" id="dateTo" onchange="filterNotifications()">
    </div>
    <button onclick="clearFilters()" class="clear-btn">Xóa bộ lọc</button>
</div>

<div class="notification-list" id="notificationListContainer">
    <!-- Notifications will be loaded here -->
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyD_rJgBFgBulheVenQUE2KXr4PBpSpTCxw",
        authDomain: "etax-7fbf8.firebaseapp.com",
        databaseURL: "https://etax-7fbf8-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "etax-7fbf8",
        storageBucket: "etax-7fbf8.appspot.com",
        messagingSenderId: "1030026724634",
        appId: "1:1030026724634:web:d76f5f9dad43bad6fd58a3"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let allNotifications = [];
    let filteredNotifications = [];

    document.addEventListener('DOMContentLoaded', function() {
        const loggedInMST = localStorage.getItem('etax_logged_in_user');
        if (!loggedInMST) {
            // window.location.href = '/login.html'; // DISABLED FOR SIMULATOR
            return;
        }
        loadNotifications(loggedInMST);
        
        // Add click handler for red dot indicators
        document.addEventListener('click', function(e) {
            if (e.target.closest('.notification-item')) {
                const notificationItem = e.target.closest('.notification-item');
                const rect = notificationItem.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                const clickY = e.clientY - rect.top;
                
                // Check if click is near the red dot (right side, top area)
                if (clickX > rect.width - 30 && clickY < 30) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Show expanded content or navigate to detail
                    const href = notificationItem.getAttribute('href');
                    if (href) {
                        window.location.href = href;
                    }
                }
            }
        });
    });

    async function loadNotifications(mst) {
        const container = document.getElementById('notificationListContainer');
        container.innerHTML = '<p>Đang tải thông báo...</p>';

        try {
            const snapshot = await db.ref('notifications').orderByChild('publishDate').once('value');
            const allNotifications = snapshot.val() || {};

            const userNotifications = Object.entries(allNotifications).filter(([key, notif]) => {
                return notif.type === 'general' || (notif.type === 'personal' && notif.targetUser === mst);
            });

            if (userNotifications.length === 0) {
                container.innerHTML = '<p>Không có thông báo nào.</p>';
                
                // Thêm thông báo mặc định từ ảnh anh cung cấp
                const defaultNotificationHtml = `
                    <div class="notification-item-wrapper">
                        <div class="notification-time-standalone">27/06/2025 15:05:59</div>
                        <a href="chi-tiet-thong-bao.html?id=default_system_suspension_new" class="notification-item">
                            <div class="notification-title">Thông báo kế hoạch tạm dừng hệ thống</div>
                            <div class="notification-content">Cục Thuế thông báo về việc tạm dừng các hệ thống thuế điện tử từ 18h00 ngày 27/6/2025 (...)</div>
                            <span class="notification-category category-system">Hệ thống</span>
                        </a>
                    </div>
                    <div class="notification-item-wrapper">
                        <div class="notification-time-standalone">13/06/2025 16:24:25</div>
                        <a href="chi-tiet-thong-bao.html?id=default_system_suspension" class="notification-item">
                            <div class="notification-title">Thông báo kế hoạch tạm dừng hệ thống</div>
                            <div class="notification-content">Cục Thuế thông báo về việc tạm dừng Dịch vụ Thuế điện tử trên thiết bị di động (eTax Mobil...)</div>
                            <span class="notification-category category-system">Hệ thống</span>
                        </a>
                    </div>
                    <div class="notification-item-wrapper">
                        <div class="notification-time-standalone">11/10/2025 12:37:23</div>
                        <a href="chi-tiet-thong-bao.html?id=default_tax_payment" class="notification-item">
                            <div class="notification-title">Giao dịch nộp thuế</div>
                            <div class="notification-content">Người nộp thuế đã nộp thuế thành công. Mã tham chiếu: 11020250044818128. Số tiền nộp: ...</div>
                            <span class="notification-category category-payment">Thanh toán</span>
                        </a>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', defaultNotificationHtml);
                return;
            }

            // Sort by publishDate descending (newest first)
            userNotifications.sort((a, b) => b[1].publishDate - a[1].publishDate);

            // Store in global variables
            allNotifications = userNotifications;
            filteredNotifications = [...userNotifications];

            // Display notifications
            displayNotifications();

        } catch (error) {
            console.error("Error loading notifications:", error);
            container.innerHTML = '<p>Lỗi khi tải thông báo.</p>';
        }
    }

    function displayNotifications() {
        const container = document.getElementById('notificationListContainer');
        container.innerHTML = '';

        if (filteredNotifications.length === 0) {
            container.innerHTML = '<p>Không có thông báo nào phù hợp với bộ lọc.</p>';
            
            // Thêm thông báo mặc định từ ảnh anh cung cấp
            const defaultNotificationHtml = `
                <div class="notification-item-wrapper">
                    <div class="notification-time-standalone">27/06/2025 15:05:59</div>
                    <a href="chi-tiet-thong-bao.html?id=default_system_suspension_new" class="notification-item">
                        <div class="notification-title">Thông báo kế hoạch tạm dừng hệ thống</div>
                        <div class="notification-content">Cục Thuế thông báo về việc tạm dừng các hệ thống thuế điện tử từ 18h00 ngày 27/6/2025 (...)</div>
                        <span class="notification-category category-system">Hệ thống</span>
                    </a>
                </div>
                <div class="notification-item-wrapper">
                    <div class="notification-time-standalone">13/06/2025 16:24:25</div>
                    <a href="chi-tiet-thong-bao.html?id=default_system_suspension" class="notification-item">
                        <div class="notification-title">Thông báo kế hoạch tạm dừng hệ thống</div>
                        <div class="notification-content">Cục Thuế thông báo về việc tạm dừng Dịch vụ Thuế điện tử trên thiết bị di động (eTax Mobil...)</div>
                        <span class="notification-category category-system">Hệ thống</span>
                    </a>
                </div>
                <div class="notification-item-wrapper">
                    <div class="notification-time-standalone">11/10/2025 12:37:23</div>
                    <a href="chi-tiet-thong-bao.html?id=default_tax_payment" class="notification-item">
                        <div class="notification-title">Giao dịch nộp thuế</div>
                        <div class="notification-content">Người nộp thuế đã nộp thuế thành công. Mã tham chiếu: 11020250044818128. Số tiền nộp: ...</div>
                        <span class="notification-category category-payment">Thanh toán</span>
                    </a>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', defaultNotificationHtml);
            return;
        }

        filteredNotifications.forEach(([key, notif]) => {
            const wrapper = document.createElement('div');
            wrapper.className = 'notification-item-wrapper';

            const timeDiv = document.createElement('div');
            timeDiv.className = 'notification-time-standalone';
            timeDiv.textContent = new Date(notif.publishDate).toLocaleString('vi-VN');

            const itemLink = document.createElement('a');
            itemLink.className = 'notification-item';
            itemLink.href = `chi-tiet-thong-bao.html?id=${key}`;
            
            // Tạo nội dung thông báo
            let content = '';
            if (notif.content && notif.content.length > 100) {
                content = notif.content.substring(0, 100) + '...';
            } else {
                content = notif.content || '';
            }
            
            // Tạo category badge
            let categoryBadge = '';
            if (notif.category) {
                const categoryNames = {
                    'payment': 'Thanh toán',
                    'system': 'Hệ thống',
                    'account': 'Tài khoản',
                    'tax_obligation': 'Nghĩa vụ thuế',
                    'update': 'Cập nhật'
                };
                const categoryName = categoryNames[notif.category] || notif.category;
                categoryBadge = `<span class="notification-category category-${notif.category}">${categoryName}</span>`;
            }
            
            itemLink.innerHTML = `
                <div class="notification-title">${notif.title}</div>
                <div class="notification-content">${content}</div>
                ${categoryBadge}
            `;

            wrapper.appendChild(timeDiv);
            wrapper.appendChild(itemLink);
            container.appendChild(wrapper);
        });
    }

    function filterNotifications() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const typeFilter = document.getElementById('typeFilter').value;
        const categoryFilter = document.getElementById('categoryFilter').value;
        const dateFrom = document.getElementById('dateFrom').value;
        const dateTo = document.getElementById('dateTo').value;

        filteredNotifications = allNotifications.filter(([key, notif]) => {
            // Text search
            if (searchTerm) {
                const searchableText = (notif.title + ' ' + notif.content).toLowerCase();
                if (!searchableText.includes(searchTerm)) {
                    return false;
                }
            }

            // Type filter
            if (typeFilter && notif.type !== typeFilter) {
                return false;
            }

            // Category filter
            if (categoryFilter && notif.category !== categoryFilter) {
                return false;
            }

            // Date filters
            const notificationDate = new Date(notif.publishDate);
            if (dateFrom) {
                const fromDate = new Date(dateFrom);
                if (notificationDate < fromDate) {
                    return false;
                }
            }
            if (dateTo) {
                const toDate = new Date(dateTo);
                toDate.setHours(23, 59, 59, 999); // End of day
                if (notificationDate > toDate) {
                    return false;
                }
            }

            return true;
        });

        displayNotifications();
    }

    function toggleAdvancedSearch() {
        const advancedSearch = document.getElementById('advancedSearch');
        const button = event.target.closest('button');
        
        if (advancedSearch.style.display === 'none') {
            advancedSearch.style.display = 'grid';
            button.innerHTML = '<i class="fas fa-minus"></i> Đóng';
        } else {
            advancedSearch.style.display = 'none';
            button.innerHTML = '<i class="fas fa-plus"></i> Nâng cao';
        }
    }

    function clearFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('typeFilter').value = '';
        document.getElementById('categoryFilter').value = '';
        document.getElementById('dateFrom').value = '';
        document.getElementById('dateTo').value = '';
        
        filteredNotifications = [...allNotifications];
        displayNotifications();
    }

    // ✅ PWA LOCK SETTINGS
    // Block double-tap zoom
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function(e) {
        const now = Date.now();
        if (now - lastTouchEnd <= 300) {
            e.preventDefault();
        }
        lastTouchEnd = now;
    }, false);

    // Block context menu
    document.addEventListener('contextmenu', function(e) {
        e.preventDefault();
    });

    // Block iOS swipe back gesture
    document.addEventListener('touchstart', function(e) {
        if (e.touches.length > 1) {
            e.preventDefault();
        }
    });

    // Block drag and drop
    document.addEventListener('dragstart', function(e) {
        e.preventDefault();
    });
</script>

</body>
</html>
